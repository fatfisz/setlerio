<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>canvas{left:50%;max-height:100%;max-width:100%;position:fixed;top:50%;transform:translate(-50%,-50%)}</style><body><script>"use strict";const t={"#0f7":"#084","#282":"#141","#853":"#432","#ed0":"#770"},n={"#000":[0,0,0]};function e(t,e,o){const[s,r,i]=n[o];t[e]=s,t[e+1]=r,t[e+2]=i,t[e+3]=255}function o(t,n){t.beginPath();const[e,...o]=n;t.moveTo(...e.toArray());for(const n of o)t.lineTo(...n.toArray());t.closePath()}let s=0;const r=new Map;function i(...t){return s+=1,r.set(s,t),s}function a(t){r.delete(t)}function c(t,n,e=!1){const o=document.createElement("canvas");o.width=t,o.height=n;const s=o.getContext("2d");return s.imageSmoothingEnabled=e,[o,s]}class f{constructor(t,n){this.x=t,this.y=n}add(t){return new f(this.x+t.x,this.y+t.y)}mul(t){return new f(this.x*t,this.y*t)}sub(t){return new f(this.x-t.x,this.y-t.y)}toHex(){return new f(this.x/240+this.y/120,this.x/240-this.y/120)}toCanvas(){return new f(240*(this.x+this.y)/2,120*(this.x-this.y)/2)}round(){return new f(Math.round(this.x),Math.round(this.y))}equal(t){return Boolean(t&&this.x===t.x&&this.y===t.y)}distance(t){return((this.x-t.x)**2+(this.y-t.y)**2)**.5}toArray(){return[this.x,this.y]}toHash(){return`${this.x},${this.y}`}}function u(t){const n=t.indexOf(",");return new f(Number(t.slice(0,n)),Number(t.slice(n+1)))}const l=[new f(-40,-60),new f(40,-60),new f(80,0),new f(40,60),new f(-40,60),new f(-80,0)];function h(t,n,e=0){return 0===n?[t]:[...d(n).map((e,o,s)=>new f(t.x+e,t.y+s[(o+2*n)%s.length])),...n>e?h(t,n-1,e):[]]}function d(t){return[...m(t),...m(t).map(t=>-t)]}function m(t){return 0===t?[]:[-t,1-t,...m(t-1).map(t=>t+1),t]}const w=h(new f(0,0),1);function v(t){const n=Math.abs(t.x),e=Math.abs(t.y);return e<=60&&(n<=40||80-n>=e*(80/120))}const y=new Map;function g(t,n){const e=String(t);return y.has(e)||y.set(e,n()),y.get(e)}const x={0:273258,1:271514,2:291491,3:276643,4:282441,5:276687,6:273098,7:271655,8:273066,9:272810,a:285679,b:277227,c:291407,d:277355,e:291535,f:266959,g:293711,h:285677,i:95,j:289575,k:285421,l:291401,m:1092147057,n:17407417,o:293743,p:267247,q:424815,r:284655,s:293327,t:271511,u:293741,v:273261,w:1106957873,x:285357,y:271853,z:291495," ":4096,".":80,",":112,"'":67,"!":87,":":74,"?":270503,"%":283301,"[":4951,"]":5035,"-":4144,">":267537,"âˆž":1074091328};function p(t,n,e,o,s,r=0,i=0,a=3){const f=g([n,e,a],()=>{const t=function(t,n){return g(["text",t,n],()=>{const[e,o]=function(t){const n=t.split("\n");return[Math.max(...n.map(M)),9*n.length-3]}(t),[s,r]=c(e,o),i=r.createImageData(e,o);let a=0,f=0;for(const e of t)"\n"===e?(a+=9,f=0):(H(i,n,f,a,e),f+=1+b(x[e]));return r.putImageData(i,0,0),s})}(n,e),[o,s]=c(t.width*a,t.height*a);return s.drawImage(t,0,0,t.width*a,t.height*a),o});t.drawImage(f,o-f.width*r,s-f.height*i)}function H(t,n,o,s,r){const i=x[r],a=b(i);for(let r=0;r<6*a;r+=1)if(i&1<<r){const i=o+r%a,c=s+Math.floor(r/a);e(t.data,4*(c*t.width+i),n)}}function M(t){return[...t].reduce((t,n)=>t+b(x[n]),1*Math.max(t.length-1,0))}function b(t){return(t.toString(2).length-1)/6}let S=!1,A={left:0,top:0,height:0},k=-1,E=[],L=new f(0,0);function C(){return S}function q(){S=!1,a(k)}function D(t,n=L){q(),S=!0,k=i(4,R);const e=48*t.length,o=32+e;A={left:16+Math.max(0,Math.min(712,n.x-144)),top:n.y+16-(n.y>728?o:0),height:e},E=t,L=n}function R(t){Q(()=>{t.fillStyle="#fff",t.fillRect(A.left,A.top,256,A.height);for(const[n,[e,o]]of E.entries())p(t,e,"#000",A.left+16,A.top+48*(n+.5),0,.5),Array.isArray(o)&&p(t,">","#000",A.left+256-16,A.top+48*(n+.5),1,.5)})}function T(t,n){return t.x>=A.left&&t.x<A.left+256&&t.y>=A.top+48*n&&t.y<A.top+48*(n+1)}const[$,j]=c(1e3,1e3,!0);$.style.background="#d6eaf8";let F,I,O,W=new f(0,0),J=1,P=!1,z=!1;const B=new f(500,500);function N(t){const n=$.getBoundingClientRect();return new f(1e3/n.width*(t.clientX-n.left),1e3/n.height*(t.clientY-n.top))}function Y(t){const n=t.sub(B).mul(1/J).add(W),e={relative:t,canvas:n,hex:new f(0,0)},o=n.toHex().round().toCanvas();for(const t of w){const s=o.add(t.toCanvas());v(n.sub(s))&&(e.hex=s.toHex())}return e}function X(t,n){return t.sub(B).mul(1/J).sub(n).mul(-1)}function G(t,n){const e=t.sub(n).toCanvas();return Math.abs(e.x)<=1160&&Math.abs(e.y)<=1120}function K(){var t,n;return null!=(t=O)?t:null==(n=F)?void 0:n.hex}function Q(t){j.save(),j.resetTransform(),t(),j.restore()}let U=0;function V(t){return Math.round(.06*t)}class Z{constructor(t,n,e){this.run=t,this.frame=U+1+V(e),this.totalFrames=V(n)}}let _=0;const tt=new Map;function nt(t,n=0,e=0){return _+=1,tt.set(_,new Z(t,n,e)),_}const et=[new f(-60,-12),new f(60,-12),new f(60,12),new f(-60,12)],ot={food:100,wood:100,stone:100,iron:100,gold:100};function st([t],n=1){for(const[e,o]of t)ot[e]+=Math.ceil(o*n)}const rt=new Set,it=new Set;let at=!1;const ct=[["",,,!0],["town center",,,!0],["tower",[[["wood",2],["stone",3]],5e3]],["lumberjack's hut",[[["wood",2],["stone",2]],5e3],[[["wood",1]],5e3]]],ft=new Map,ut=new Set,lt=new Set;function ht(t,n){wt(t,n,!0),mt(n)&&vt(t)}function dt(t){const[n]=ft.get(t.toHash());wt(t,0,!0),mt(n)&&vt(t)}function mt(t){return 1===t||2===t}function wt(t,n,e){const o=t.toHash();if(ft.has(o)){if(!e)return;yt(ft.get(o))}ft.set(o,[n,t,i(1,pt(t,ct[n][0]),t)])}function vt(t){const n=new Set,e=new Set,o=0!==ft.get(t.toHash())[0];for(const o of h(t,4)){const t=ft.get(o.toHash());if(t&&mt(t[0])){for(const e of h(t[1],2,2))n.add(e.toHash());for(const n of h(t[1],1))e.add(n.toHash())}}if(o){for(const n of h(t,2))wt(n,0,!1);for(const n of h(t,2,2)){const t=n.toHash();e.has(t)||lt.add(t)}for(const n of h(t,1)){const t=n.toHash();lt.delete(t)}}else{for(const t of e)n.delete(t);for(const o of h(t,2)){const t=o.toHash();n.has(t)?lt.add(t):e.has(t)||(yt(ft.get(t)),ft.delete(t),ut.add(t),lt.delete(t))}}}function yt([,,t,n]){a(t),n&&n()}function gt(t,n){const[,e]=ct[n],s=function([t]){const n=t.filter(([t,n])=>n>ot[t]).map(([t,n])=>`${n-ot[t]} ${t}`);if(n.length>0)return"missing: "+n.join(", ")}(e);if(s)return void function t(...n){at?it.add(n):(rt.add(n),at=!0,nt(function(n){return(e,o)=>{if(n[1]=e/o-1,n[2]=e/o,e===o&&(at=!1,it.size>0)){const[n]=it;it.delete(n),t(...n)}}}(n),200),nt(function(t){return(n,e)=>{t[1]=n/e/3,t[2]=1-n/e,n===e&&rt.delete(t)}}(n),200,5200))}(s,-1,0);const r=ft.get(t.toHash()),[c,f]=function(t){const n={progress:0},e=i(2,function(t,n){return e=>{const s=t.toCanvas(),r=(100*n.progress).toFixed(0)+"%";o(e,et.map(t=>t.add(s))),e.lineWidth=3,e.lineJoin="miter",e.strokeStyle="#fff",e.stroke(),e.fillStyle="#fff",e.fillRect(...s.add(et[0]).toArray(),120*n.progress,24),p(e,r,"#000",...s.toArray(),.5,.5)}}(t,n),t);return[t=>{n.progress=t},()=>{a(e)}]}(t),u=nt((e,o)=>{e===o?(function(t){C()&&t.equal(O)&&(q(),O=void 0)}(t),f(),r[3]=void 0,ht(t,n)):c(e/o)},e[1]);r[3]=()=>{st(e),f(),tt.delete(u),r[3]=void 0},function([t]){for(const[n,e]of t)ot[n]-=e}(e)}let xt=0;function pt(t,n){return e=>{const s=t.toCanvas();if(t.equal(K())&&function(t){const[n]=ft.get(t.toHash());return 0===n||!ct[n][3]}(t)){const t=Math.abs(1-2*xt/5)**2,n=1*t+1.03*(1-t);o(e,l.map(t=>t.mul(n).add(s))),e.lineWidth=5,e.strokeStyle="#fff",e.stroke()}n&&p(e,n,"#000",...s.toArray(),.5,.5)}}let Ht=0;const Mt=["#0f7","#282","#853","#ed0"],bt=[1,2],St=[3,5];function At(n,e){return s=>{const r=n.toCanvas();o(s,l.map(t=>t.add(r))),s.fillStyle=ft.has(n.toHash())?Mt[e]:t[Mt[e]],s.lineJoin="round",s.lineWidth=.75,s.strokeStyle="#000",s.fill(),s.stroke()}}let kt=0;document.title="setlerio",i(3,(function(t){Q(()=>{let n=0;t.fillStyle="#fff";for(const e of[...rt].reverse()){const[o,s,r]=e;n+=1+s;const i=1e3-88*n;t.globalAlpha=r,t.fillRect(528,i,448,64),p(t,o,"#000",552,i+32,0,.5)}})})),i(3,(function(t){Q(()=>{t.fillStyle="#fff",t.fillRect(0,0,1e3,48),p(t,Object.entries(ot).map(([t,n])=>`${t}: ${String(n).padStart(4," ")}`).join("   "),"#000",24,24,0,.5)})})),function(){const t=new Map,n=new Set(w.map(t=>t.toHash()));function e(o,s,[r,i],a=!1,c=r+Math.random()*(i-r)){if((a||!n.has(s.toHash()))&&!(c<=0)){t.set(s.toHash(),o),e(o,s.add(w[Math.floor(Math.random()*w.length)]),[0,0],a,c-1);for(const t of w)n.add(s.add(t).toHash())}}for(let t=-28;t<=28;t+=1)for(let n=-28;n<=28;n+=1){const o=(n**2+t**2)**.5;o<28&&o>26.5&&e(3,new f(n,t),bt,!0)}for(let n=-28;n<=28;n+=1)for(let o=-28;o<=28;o+=1)if((o**2+n**2)**.5<28){const s=new f(o,n);if(!t.has(s.toHash())){const n=Math.random();n<.4?t.set(s.toHash(),0):n<.85?t.set(s.toHash(),1):n<.95?e(2,s,St):e(3,s,bt)}t.has(s.toHash())||t.set(s.toHash(),0)}t.set(new f(0,0).toHash(),0);for(const[n,e]of t.entries()){const t=u(n);i(0,At(t,e),t)}}(),document.body.append($),$.addEventListener("mousemove",t=>{F=Y(N(t))}),document.addEventListener("mousemove",t=>{I&&(F=Y(N(t)),!P&&I.relative.distance(F.relative)>5&&(P=!0),P&&(W=X(F.relative,I.canvas),F=Y(N(t))))}),$.addEventListener("contextmenu",t=>{t.preventDefault()}),$.addEventListener("wheel",t=>{O&&(q(),O=void 0),F&&(J=Math.max(.5,Math.min(1,J-.0625*Math.sign(t.deltaY))),W=X(F.relative,F.canvas))}),$.addEventListener("mouseout",()=>{P||(F=void 0)}),$.addEventListener("mousedown",t=>{if(t.preventDefault(),F=Y(N(t)),O){if(function(t){for(const[n,[,e]]of E.entries())if(T(t,n))return Array.isArray(e)?D(e):(q(),e()),!0;return q(),!1}(F.relative))return z=!0,void(C()||(O=void 0));O.equal(F.hex)&&(z=!0),O=void 0}I=F}),$.addEventListener("mouseup",t=>{if(F=Y(N(t)),!P&&!z&&I&&I.hex.equal(F.hex)){const t=function(t){const n=t.toHash();if(!ft.has(n))return;const[e,,,o]=ft.get(n);return o?[["cancel",()=>function(t){const[,,,n]=ft.get(t.toHash());n()}(t)]]:0===e?[["build",[[ct[3][0],()=>gt(t,3)],[ct[2][0],()=>gt(t,2)]]]]:ct[e][3]?void 0:[["destroy",()=>function(t){const[n]=ft.get(t.toHash()),[,e]=ct[n];st(e,.5),dt(t)}(t)]]}(I.hex);t&&(O=I.hex,D(t,I.relative))}}),document.addEventListener("mouseup",()=>{F&&(F.relative.x<0||F.relative.y<0||F.relative.x>1e3||F.relative.y>1e3)&&(F=void 0),I=void 0,P=!1,z=!1}),document.addEventListener("visibilitychange",()=>{F=void 0,I=void 0,P=!1,z=!1}),nt((function(t){xt=.10416666666666666*t%5}),1/0),i(2,(function(t){t.beginPath();for(const n of lt){const e=u(n);if(!e.equal(K())){const n=e.toCanvas();for(let o=0;o<6;o+=1)ft.has(e.add(w[o]).toHash())||(t.moveTo(...n.add(l[o]).toArray()),t.lineTo(...n.add(l[(o+1)%6]).toArray()))}}t.lineJoin="round",t.lineWidth=4.5,t.strokeStyle="#fff",t.lineDashOffset=Ht,t.setLineDash([6,4]),t.stroke(),t.lineDashOffset=0,t.setLineDash([])})),nt((function(t){Ht=.20833333333333331*t%10}),1/0),ht(new f(0,0),1),ht(new f(2,-2),2),ht(new f(3,-1),2),dt(new f(2,-2)),function t(n){requestAnimationFrame(t),n>=kt+15.666666666666668&&(kt=n,U+=1,function(){for(const[t,n]of tt.entries()){const e=U-n.frame;e>n.totalFrames?tt.delete(t):e>=0&&n.run(e,n.totalFrames)}}(),function(){j.resetTransform(),j.clearRect(0,0,1e3,1e3),j.translate(500,500),j.scale(J,J),j.translate(-W.x,-W.y);const t=[[],[],[],[],[]],n=W.toHex();for(const[e,o,s]of r.values())s&&!G(s,n)||t[e].push(o);for(const n of t)for(const t of n)t(j)}())}(0);</script>
