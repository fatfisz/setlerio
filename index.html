<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>canvas{left:50%;max-height:100%;max-width:100%;position:fixed;top:50%;transform:translate(-50%,-50%)}</style><body><script>"use strict";function t(t,e){t.beginPath();const[n,...o]=e;t.moveTo(...n.toArray());for(const e of o)t.lineTo(...e.toArray());t.closePath()}let e=0;const n=new Map;function o(...t){return e+=1,n.set(e,t),e}function s(t){n.delete(t)}function r(t,e,n=!1){const o=document.createElement("canvas");o.width=t,o.height=e;const s=o.getContext("2d");return s.imageSmoothingEnabled=n,[o,s]}class i{constructor(t,e){this.x=t,this.y=e}add(t){return new i(this.x+t.x,this.y+t.y)}mul(t){return new i(this.x*t,this.y*t)}sub(t){return new i(this.x-t.x,this.y-t.y)}toHex(){return new i(this.x/240+this.y/120,this.x/240-this.y/120)}toCanvas(){return new i(240*(this.x+this.y)/2,120*(this.x-this.y)/2)}round(){return new i(Math.round(this.x),Math.round(this.y))}equal(t){return Boolean(t&&this.x===t.x&&this.y===t.y)}distance(t){return((this.x-t.x)**2+(this.y-t.y)**2)**.5}toArray(){return[this.x,this.y]}toHash(){return`${this.x},${this.y}`}}function a(t){const e=t.indexOf(",");return new i(Number(t.slice(0,e)),Number(t.slice(e+1)))}const c=[new i(-40,-60),new i(40,-60),new i(80,0),new i(40,60),new i(-40,60),new i(-80,0)];function f(t,e,n=0){return 0===e?[t]:[...u(e).map((n,o,s)=>new i(t.x+n,t.y+s[(o+2*e)%s.length])),...e>n?f(t,e-1,n):[]]}function u(t){return[...l(t),...l(t).map(t=>-t)]}function l(t){return 0===t?[]:[-t,1-t,...l(t-1).map(t=>t+1),t]}const h=f(new i(0,0),1);function d(t){const e=Math.abs(t.x),n=Math.abs(t.y);return n<=60&&(e<=40||80-e>=n*(80/120))}function w(t,e,[n,o,s]){t[e]=n,t[e+1]=o,t[e+2]=s,t[e+3]=255}const m=new Map;function v(t,e){const n=String(t);return m.has(n)||m.set(n,e()),m.get(n)}const g={0:273258,1:271514,2:291491,3:276643,4:282441,5:276687,6:273098,7:271655,8:273066,9:272810,a:285679,b:277227,c:291407,d:277355,e:291535,f:266959,g:293711,h:285677,i:95,j:289575,k:285421,l:291401,m:1092147057,n:17407417,o:293743,p:267247,q:424815,r:284655,s:293327,t:271511,u:293741,v:273261,w:1106957873,x:285357,y:271853,z:291495," ":4096,".":80,",":112,"'":67,"!":87,":":74,"?":270503,"%":283301,"[":4951,"]":5035,"-":4144,">":267537,"âˆž":1074091328};function y(t,e,n,o,s,i=0,a=0,c=3){const f=v([e,n,c],()=>{const t=function(t,e){return v(["text",t,e],()=>{const[n,o]=function(t){const e=t.split("\n");return[Math.max(...e.map(p)),9*e.length-3]}(t),[s,i]=r(n,o),a=i.createImageData(n,o);let c=0,f=0;for(const n of t)"\n"===n?(c+=9,f=0):(x(a,e,f,c,n),f+=1+H(g[n]));return i.putImageData(a,0,0),s})}(e,n),[o,s]=r(t.width*c,t.height*c);return s.drawImage(t,0,0,t.width*c,t.height*c),o});t.drawImage(f,o-f.width*i,s-f.height*a)}function x(t,e,n,o,s){const r=g[s],i=H(r);for(let s=0;s<6*i;s+=1)if(r&1<<s){const r=n+s%i,a=o+Math.floor(s/i);w(t.data,4*(a*t.width+r),e)}}function p(t){return[...t].reduce((t,e)=>t+H(g[e]),1*Math.max(t.length-1,0))}function H(t){return(t.toString(2).length-1)/6}let M=!1,b={left:0,top:0,height:0},S=-1,A=[],k=new i(0,0);function E(){return M}function L(){M=!1,s(S)}function C(t,e=k){L(),M=!0,S=o(4,D);const n=48*t.length,s=32+n;b={left:16+Math.max(0,Math.min(712,e.x-144)),top:e.y+16-(e.y>728?s:0),height:n},A=t,k=e}function D(t){G(()=>{t.fillStyle="white",t.fillRect(b.left,b.top,256,b.height);for(const[e,[n,o]]of A.entries())y(t,n,[0,0,0],b.left+16,b.top+48*(e+.5),0,.5),Array.isArray(o)&&y(t,">",[0,0,0],b.left+256-16,b.top+48*(e+.5),1,.5)})}function q(t,e){return t.x>=b.left&&t.x<b.left+256&&t.y>=b.top+48*e&&t.y<b.top+48*(e+1)}const[F,R]=r(1e3,1e3,!0);F.style.background="#D6EAF8";let T,$,j,I=new i(0,0),O=1,W=!1,J=!1;const P=new i(500,500);function z(t){const e=F.getBoundingClientRect();return new i(1e3/e.width*(t.clientX-e.left),1e3/e.height*(t.clientY-e.top))}function B(t){const e=t.sub(P).mul(1/O).add(I),n={relative:t,canvas:e,hex:new i(0,0)},o=e.toHex().round().toCanvas();for(const t of h){const s=o.add(t.toCanvas());d(e.sub(s))&&(n.hex=s.toHex())}return n}function N(t,e){return t.sub(P).mul(1/O).sub(e).mul(-1)}function Y(t,e){const n=t.sub(e).toCanvas();return Math.abs(n.x)<=1160&&Math.abs(n.y)<=1120}function X(){var t,e;return null!=(t=j)?t:null==(e=T)?void 0:e.hex}function G(t){R.save(),R.resetTransform(),t(),R.restore()}let K=0;function Q(t){return Math.round(.06*t)}class U{constructor(t,e,n){this.run=t,this.frame=K+1+Q(n),this.totalFrames=Q(e)}}let V=0;const Z=new Map;function _(t,e=0,n=0){return V+=1,Z.set(V,new U(t,e,n)),V}const tt=[new i(-60,-12),new i(60,-12),new i(60,12),new i(-60,12)],et={food:100,wood:100,stone:100,iron:100,gold:100};function nt([t],e=1){for(const[n,o]of t)et[n]+=Math.ceil(o*e)}const ot=new Set,st=new Set;let rt=!1;const it=[["",,,!0],["town center",,,!0],["tower",[[["wood",2],["stone",3]],5e3]],["lumberjack's hut",[[["wood",2],["stone",2]],5e3],[[["wood",1]],5e3]]],at=new Map,ct=new Set,ft=new Set;function ut(t,e){dt(t,e,!0),ht(e)&&wt(t)}function lt(t){const[e]=at.get(t.toHash());dt(t,0,!0),ht(e)&&wt(t)}function ht(t){return 1===t||2===t}function dt(t,e,n){const s=t.toHash();if(at.has(s)){if(!n)return;mt(at.get(s))}at.set(s,[e,t,o(1,yt(t,it[e][0]),t)])}function wt(t){const e=new Set,n=new Set,o=0!==at.get(t.toHash())[0];for(const o of f(t,4)){const t=at.get(o.toHash());if(t&&ht(t[0])){for(const n of f(t[1],2,2))e.add(n.toHash());for(const e of f(t[1],1))n.add(e.toHash())}}if(o){for(const e of f(t,2))dt(e,0,!1);for(const e of f(t,2,2)){const t=e.toHash();n.has(t)||ft.add(t)}for(const e of f(t,1)){const t=e.toHash();ft.delete(t)}}else{for(const t of n)e.delete(t);for(const o of f(t,2)){const t=o.toHash();e.has(t)?ft.add(t):n.has(t)||(mt(at.get(t)),at.delete(t),ct.add(t),ft.delete(t))}}}function mt([,,t,e]){s(t),e&&e()}function vt(e,n){const[,r]=it[n],i=function([t]){const e=t.filter(([t,e])=>e>et[t]).map(([t,e])=>`${e-et[t]} ${t}`);if(e.length>0)return"missing: "+e.join(", ")}(r);if(i)return void function t(...e){rt?st.add(e):(ot.add(e),rt=!0,_(function(e){return(n,o)=>{if(e[1]=n/o-1,e[2]=n/o,n===o&&(rt=!1,st.size>0)){const[e]=st;st.delete(e),t(...e)}}}(e),200),_(function(t){return(e,n)=>{t[1]=e/n/3,t[2]=1-e/n,e===n&&ot.delete(t)}}(e),200,5200))}(i,-1,0);const a=at.get(e.toHash()),[c,f]=function(e){const n={progress:0},r=o(2,function(e,n){return o=>{const s=e.toCanvas(),r=(100*n.progress).toFixed(0)+"%";t(o,tt.map(t=>t.add(s))),o.fillStyle="#fff3",o.lineWidth=3,o.lineJoin="miter",o.strokeStyle="white",o.fill(),o.stroke(),o.fillStyle="white",o.fillRect(...s.add(tt[0]).toArray(),120*n.progress,24),y(o,r,[0,0,0],...s.toArray(),.5,.5)}}(e,n),e);return[t=>{n.progress=t},()=>{s(r)}]}(e),u=_((t,o)=>{t===o?(function(t){E()&&t.equal(j)&&(L(),j=void 0)}(e),f(),a[3]=void 0,ut(e,n)):c(t/o)},r[1]);a[3]=()=>{nt(r),f(),Z.delete(u),a[3]=void 0},function([t]){for(const[e,n]of t)et[e]-=n}(r)}let gt=0;function yt(e,n){return o=>{const s=e.toCanvas();if(e.equal(X())&&function(t){const[e]=at.get(t.toHash());return 0===e||!it[e][3]}(e)){const e=Math.abs(1-2*gt/5)**2,n=1*e+1.03*(1-e);t(o,c.map(t=>t.mul(n).add(s))),o.lineWidth=5,o.strokeStyle="#fff",o.stroke()}n&&y(o,n,[0,0,0],...s.toArray(),.5,.5)}}let xt=0;const pt=["springgreen","forestgreen","sienna","gold"],Ht=[1,2],Mt=[3,5];function bt(e,n){return o=>{const s=e.toCanvas();t(o,c.map(t=>t.add(s))),o.fillStyle=pt[n],o.lineJoin="round",o.lineWidth=.5,o.strokeStyle="black",o.fill(),o.stroke(),at.has(e.toHash())||(o.fillStyle="#0008",o.fill())}}let St=0;document.title="setlerio",o(3,(function(t){G(()=>{let e=0;t.fillStyle="white";for(const n of[...ot].reverse()){const[o,s,r]=n;e+=1+s,t.globalAlpha=r;const i=1e3-88*e;t.fillRect(528,i,448,64),y(t,o,[0,0,0],552,i+32,0,.5)}})})),o(3,(function(t){G(()=>{t.fillStyle="white",t.fillRect(0,0,1e3,48),y(t,Object.entries(et).map(([t,e])=>`${t}: ${String(e).padStart(4," ")}`).join("   "),[0,0,0],24,24,0,.5)})})),function(){const t=new Map,e=new Set(h.map(t=>t.toHash()));function n(o,s,[r,i],a=!1,c=r+Math.random()*(i-r)){if((a||!e.has(s.toHash()))&&!(c<=0)){t.set(s.toHash(),o),n(o,s.add(h[Math.floor(Math.random()*h.length)]),[0,0],a,c-1);for(const t of h)e.add(s.add(t).toHash())}}for(let t=-28;t<=28;t+=1)for(let e=-28;e<=28;e+=1){const o=(e**2+t**2)**.5;o<28&&o>26.5&&n(3,new i(e,t),Ht,!0)}for(let e=-28;e<=28;e+=1)for(let o=-28;o<=28;o+=1)if((o**2+e**2)**.5<28){const s=new i(o,e);if(!t.has(s.toHash())){const e=Math.random();e<.4?t.set(s.toHash(),0):e<.85?t.set(s.toHash(),1):e<.95?n(2,s,Mt):n(3,s,Ht)}t.has(s.toHash())||t.set(s.toHash(),0)}t.set(new i(0,0).toHash(),0);for(const[e,n]of t.entries()){const t=a(e);o(0,bt(t,n),t)}}(),document.body.append(F),F.addEventListener("mousemove",t=>{T=B(z(t))}),document.addEventListener("mousemove",t=>{$&&(T=B(z(t)),!W&&$.relative.distance(T.relative)>5&&(W=!0),W&&(I=N(T.relative,$.canvas),T=B(z(t))))}),F.addEventListener("contextmenu",t=>{t.preventDefault()}),F.addEventListener("wheel",t=>{j&&(L(),j=void 0),T&&(O=Math.max(.5,Math.min(1,O-.0625*Math.sign(t.deltaY))),I=N(T.relative,T.canvas))}),F.addEventListener("mouseout",()=>{W||(T=void 0)}),F.addEventListener("mousedown",t=>{if(t.preventDefault(),T=B(z(t)),j){if(function(t){for(const[e,[,n]]of A.entries())if(q(t,e))return Array.isArray(n)?C(n):(L(),n()),!0;return L(),!1}(T.relative))return J=!0,void(E()||(j=void 0));j.equal(T.hex)&&(J=!0),j=void 0}$=T}),F.addEventListener("mouseup",t=>{if(T=B(z(t)),!W&&!J&&$&&$.hex.equal(T.hex)){const t=function(t){const e=t.toHash();if(!at.has(e))return;const[n,,,o]=at.get(e);return o?[["cancel",()=>function(t){const[,,,e]=at.get(t.toHash());e()}(t)]]:0===n?[["build",[[it[3][0],()=>vt(t,3)],[it[2][0],()=>vt(t,2)]]]]:it[n][3]?void 0:[["destroy",()=>function(t){const[e]=at.get(t.toHash()),[,n]=it[e];nt(n,.5),lt(t)}(t)]]}($.hex);t&&(j=$.hex,C(t,$.relative))}}),document.addEventListener("mouseup",()=>{T&&(T.relative.x<0||T.relative.y<0||T.relative.x>1e3||T.relative.y>1e3)&&(T=void 0),$=void 0,W=!1,J=!1}),document.addEventListener("visibilitychange",()=>{T=void 0,$=void 0,W=!1,J=!1}),_((function(t){gt=.10416666666666666*t%5}),1/0),o(2,(function(t){t.beginPath();for(const e of ft){const n=a(e);if(!n.equal(X())){const e=n.toCanvas();for(let o=0;o<6;o+=1)at.has(n.add(h[o]).toHash())||(t.moveTo(...e.add(c[o]).toArray()),t.lineTo(...e.add(c[(o+1)%6]).toArray()))}}t.lineJoin="round",t.lineWidth=4,t.strokeStyle="white",t.lineDashOffset=xt,t.setLineDash([6,4]),t.stroke(),t.lineDashOffset=0,t.setLineDash([])})),_((function(t){xt=.20833333333333331*t%10}),1/0),ut(new i(0,0),1),ut(new i(2,-2),2),ut(new i(3,-1),2),lt(new i(2,-2)),function t(e){requestAnimationFrame(t),e>=St+15.666666666666668&&(St=e,K+=1,function(){for(const[t,e]of Z.entries()){const n=K-e.frame;n>e.totalFrames?Z.delete(t):n>=0&&e.run(n,e.totalFrames)}}(),function(){R.resetTransform(),R.clearRect(0,0,1e3,1e3),R.translate(500,500),R.scale(O,O),R.translate(-I.x,-I.y);const t=[[],[],[],[],[]],e=I.toHex();for(const[o,s,r]of n.values())r&&!Y(r,e)||t[o].push(s);for(const e of t)for(const t of e)t(R)}())}(0);</script>
