<meta name=viewport content="width=device-width,initial-scale=1,user-scalable=no"><style>canvas{left:50%;max-height:100%;max-width:100%;position:fixed;top:50%;transform:translate(-50%,-50%)}</style><body><script>"use strict";const t={"#0f7":"#084","#282":"#141","#853":"#432","#ed0":"#770"},n={"#000":[0,0,0]};function e(t,e,o){const[s,r,a]=n[o];t[e]=s,t[e+1]=r,t[e+2]=a,t[e+3]=255}function o(t,n){t.beginPath();const[e,...o]=n;t.moveTo(...e.toArray());for(const n of o)t.lineTo(...n.toArray());t.closePath()}let s=0;const r=new Map;function a(...t){return s+=1,r.set(s,t),s}function i(t){r.delete(t)}function c(t,n,e=!1){const o=document.createElement("canvas");o.width=t,o.height=n;const s=o.getContext("2d");return s.imageSmoothingEnabled=e,[o,s]}class f{constructor(t,n){this.x=t,this.y=n}add(t){return new f(this.x+t.x,this.y+t.y)}mul(t){return new f(this.x*t,this.y*t)}sub(t){return new f(this.x-t.x,this.y-t.y)}toHex(){return new f(this.x/240+this.y/120,this.x/240-this.y/120)}toCanvas(){return new f(240*(this.x+this.y)/2,120*(this.x-this.y)/2)}round(){return new f(Math.round(this.x),Math.round(this.y))}equal(t){return Boolean(t&&this.x===t.x&&this.y===t.y)}distance(t){return((this.x-t.x)**2+(this.y-t.y)**2)**.5}toArray(){return[this.x,this.y]}toHash(){return`${this.x},${this.y}`}}function u(t){const n=t.indexOf(",");return new f(Number(t.slice(0,n)),Number(t.slice(n+1)))}const l=[new f(-40,-60),new f(40,-60),new f(80,0),new f(40,60),new f(-40,60),new f(-80,0)];function h(t,n,e=0){return 0===n?[t]:[...d(n).map((e,o,s)=>new f(t.x+e,t.y+s[(o+2*n)%s.length])),...n>e?h(t,n-1,e):[]]}function d(t){return[...m(t),...m(t).map(t=>-t)]}function m(t){return 0===t?[]:[-t,1-t,...m(t-1).map(t=>t+1),t]}const w=h(new f(0,0),1);function v(t){const n=Math.abs(t.x),e=Math.abs(t.y);return e<=60&&(n<=40||80-n>=e*(80/120))}const g=new Map;function y(t,n){const e=String(t);return g.has(e)||g.set(e,n()),g.get(e)}const x={0:273258,1:271514,2:291491,3:276643,4:282441,5:276687,6:273098,7:271655,8:273066,9:272810,a:285679,b:277227,c:291407,d:277355,e:291535,f:266959,g:293711,h:285677,i:95,j:289575,k:285421,l:291401,m:1092147057,n:17407417,o:293743,p:267247,q:424815,r:284655,s:293327,t:271511,u:293741,v:273261,w:1106957873,x:285357,y:271853,z:291495," ":4096,".":80,",":112,"'":67,"!":87,":":74,"?":270503,"%":283301,"[":4951,"]":5035,"-":4144,">":267537,"âˆž":1074091328};function p(t,n,e,o,s,r=0,a=0,i=3){const f=y([n,e,i],()=>{const t=function(t,n){return y(["text",t,n],()=>{const[e,o]=function(t){const n=t.split("\n");return[Math.max(...n.map(M)),9*n.length-3]}(t),[s,r]=c(e,o),a=r.createImageData(e,o);let i=0,f=0;for(const e of t)"\n"===e?(i+=9,f=0):(H(a,n,f,i,e),f+=1+S(x[e]));return r.putImageData(a,0,0),s})}(n,e),[o,s]=c(t.width*i,t.height*i);return s.drawImage(t,0,0,t.width*i,t.height*i),o});t.drawImage(f,o-f.width*r,s-f.height*a)}function H(t,n,o,s,r){const a=x[r],i=S(a);for(let r=0;r<6*i;r+=1)if(a&1<<r){const a=o+r%i,c=s+Math.floor(r/i);e(t.data,4*(c*t.width+a),n)}}function M(t){return[...t].reduce((t,n)=>t+S(x[n]),1*Math.max(t.length-1,0))}function S(t){return(t.toString(2).length-1)/6}let b=!1,A={left:0,top:0,height:0},k=-1,C=[],E=new f(0,0);function L(){return b}function q(){b=!1,i(k)}function D(t,n=E){q(),b=!0,k=a(5,T);const e=48*t.length,o=32+e;A={left:16+Math.max(0,Math.min(712,n.x-144)),top:n.y+16-(n.y>728?o:0),height:e},C=t,E=n}function T(t){Q(()=>{t.fillStyle="#fff",t.fillRect(A.left,A.top,256,A.height);for(const[n,[e,o]]of C.entries())p(t,e,"#000",A.left+16,A.top+48*(n+.5),0,.5),Array.isArray(o)&&p(t,">","#000",A.left+256-16,A.top+48*(n+.5),1,.5)})}function R(t,n){return t.x>=A.left&&t.x<A.left+256&&t.y>=A.top+48*n&&t.y<A.top+48*(n+1)}const[$,F]=c(1e3,1e3,!0);$.style.background="#d6eaf8";let W,j,z,I=new f(0,0),P=1,J=!1,O=!1;const B=new f(500,500);function N(t){const n=$.getBoundingClientRect();return new f(1e3/n.width*(t.clientX-n.left),1e3/n.height*(t.clientY-n.top))}function Y(t){const n=t.sub(B).mul(1/P).add(I),e={relative:t,canvas:n,hex:new f(0,0)},o=n.toHex().round().toCanvas();for(const t of w){const s=o.add(t.toCanvas());v(n.sub(s))&&(e.hex=s.toHex())}return e}function G(t,n){return t.sub(B).mul(1/P).sub(n).mul(-1)}function X(t,n){const e=t.sub(n).toCanvas();return Math.abs(e.x)<=1160&&Math.abs(e.y)<=1120}function K(){var t,n;return null!=(t=z)?t:null==(n=W)?void 0:n.hex}function Q(t){F.save(),F.resetTransform(),t(),F.restore()}let U=0;function V(t){return Math.round(.06*t)}class Z{constructor(t,n,e){this.run=t,this.frame=U+1+V(e),this.totalFrames=V(n)}}let _=0;const tt=new Map;function nt(t,n=0,e=0){return _+=1,tt.set(_,new Z(t,n,e)),_}const et=[new f(-60,-12),new f(60,-12),new f(60,12),new f(-60,12)],ot=["food","wood","stone","iron","gold"],st=[0,0,0,0,0],rt=new Map;function at(t){const n=t.toHash();return rt.has(n)||rt.set(n,[[0,0,0,0,0],[0,0,0,0,0],-1]),rt.get(n)}function it(t,n){const[e,o]=at(t),s=(r=e,n.map((t,n)=>Math.min(t,r[n])));var r;return console.log(n,e,s),ut(n,s),ut(e,s),ft(o,s),s.reduce((t,n,e)=>[...t,Array(n).fill(lt(e))],[]).flat()}function ct(t,n=1){for(const[e,o]of t.entries())st[e]+=Math.ceil(o*n)}function ft(t,n){for(let e=0;e<t.length;e+=1)t[e]+=n[e]}function ut(t,n){for(let e=0;e<t.length;e+=1)t[e]-=n[e]}function lt(t){const n=[0,0,0,0,0];return n[t]=1,n}const ht=new Set,dt=new Set;let mt=!1;const wt=[["",,,!0],["town center",,,!0],["tower",[0,2,3,0,0]],["lumberjack's hut",[0,2,2,0,0],[5e3,0,1,0,0,0]]],vt=new Map,gt=new Set,yt=new Set;function xt(t,n){Ht(t,n,!0),pt(n)&&Mt(t)}function pt(t){return 1===t||2===t}function Ht(t,n,e){const o=t.toHash();if(vt.has(o)){if(!e)return;St(vt.get(o))}vt.set(o,[n,t,a(1,kt(t,wt[n][0]),t)])}function Mt(t){const n=new Set,e=new Set,o=0!==vt.get(t.toHash())[0];for(const o of h(t,4)){const t=vt.get(o.toHash());if(t&&pt(t[0])){for(const e of h(t[1],2,2))n.add(e.toHash());for(const n of h(t[1],1))e.add(n.toHash())}}if(o){for(const n of h(t,2))Ht(n,0,!1);for(const n of h(t,2,2)){const t=n.toHash();e.has(t)||yt.add(t)}for(const n of h(t,1)){const t=n.toHash();yt.delete(t)}}else{for(const t of e)n.delete(t);for(const o of h(t,2)){const t=o.toHash();n.has(t)?yt.add(t):e.has(t)||(St(vt.get(t)),vt.delete(t),gt.add(t),yt.delete(t))}}}function St([,,t,n]){i(t),n&&n()}function bt(t,n){const[,e]=wt[n],s=function(t){const n=t.map((t,n)=>[t-st[n],ot[n]]).filter(([t])=>t>0).map(([t,n])=>`${t} ${n}`);if(n.length>0)return"missing: "+n.join(", ")}(e);if(s)return void function t(...n){mt?dt.add(n):(ht.add(n),mt=!0,nt(function(n){return(e,o)=>{if(n[1]=e/o-1,n[2]=e/o,e===o&&(mt=!1,dt.size>0)){const[n]=dt;dt.delete(n),t(...n)}}}(n),200),nt(function(t){return(n,e)=>{t[1]=n/e/3,t[2]=1-n/e,n===e&&ht.delete(t)}}(n),200,5200))}(s,-1,0);const r=vt.get(t.toHash()),[c,f]=function(t){const n={progress:0},e=a(2,function(t,n){return e=>{const s=t.toCanvas(),r=(100*n.progress).toFixed(0)+"%";o(e,et.map(t=>t.add(s))),e.lineWidth=3,e.lineJoin="miter",e.strokeStyle="#fff",e.stroke(),e.fillStyle="#fff",e.fillRect(...s.add(et[0]).toArray(),120*n.progress,24),p(e,r,"#000",...s.toArray(),.5,.5)}}(t,n),t);return[t=>{n.progress=t},()=>{i(e)}]}(t),u=nt((e,o)=>{e===o?(function(t){L()&&t.equal(z)&&(q(),z=void 0)}(t),f(),r[3]=void 0,xt(t,n)):c(e/o)},e[0]);r[3]=()=>{ct(e),f(),tt.delete(u),r[3]=void 0},function(t){for(const[n,e]of t.entries())st[n]-=e}(e)}let At=0;function kt(t,n){return e=>{const s=t.toCanvas();if(t.equal(K())&&function(t){const[n]=vt.get(t.toHash());return 0===n||!wt[n][3]}(t)){const t=Math.abs(1-2*At/5)**2,n=1*t+1.03*(1-t);o(e,l.map(t=>t.mul(n).add(s))),e.lineWidth=5,e.strokeStyle="#fff",e.stroke()}n&&p(e,n,"#000",...s.toArray(),.5,.5)}}let Ct=0;const Et={0:[5,0,1],1:[0,1,2],2:[1,2,3],3:[2,3,4],4:[3,4,5],5:[4,5,0],6:[0,1,2,3,4,5]};function Lt(t,n){const e=new Set([t.toHash()]),o=new Set([[t,6]]);for(const[t,s]of o)for(const r of Et[s]){const s=w[r].add(t),a=s.toHash();if(n(s))return;vt.has(a)&&!e.has(a)&&(e.add(a),o.add([s,r]))}}const qt=new Set,Dt=new Map;function Tt(){return qt.size>0}function Rt(t,n,e){let o=Math.min(n,qt.size);if(0===o)return;const s=new Map([...qt.values()].map(t=>[t.toHash(),t]));Lt(t,t=>{const n=t.toHash();if(s.has(n)){const t=s.get(n);return qt.delete(t),Dt.set(t,e(t.add(new f(1,1)))),o-=1,0===o}})}const $t=new Set,Ft=["#0f7","#282","#853","#ed0"],Wt=[1,2],jt=[3,5];function zt(n,e){return s=>{const r=n.toCanvas();o(s,l.map(t=>t.add(r))),s.fillStyle=vt.has(n.toHash())?Ft[e]:t[Ft[e]],s.lineJoin="round",s.lineWidth=.75,s.strokeStyle="#000",s.fill(),s.stroke()}}let It=0;document.title="setlerio",a(3,(function(t){Q(()=>{let n=0;t.fillStyle="#fff";for(const e of[...ht].reverse()){const[o,s,r]=e;n+=1+s;const a=1e3-88*n;t.globalAlpha=r,t.fillRect(528,a,448,64),p(t,o,"#000",552,a+32,0,.5)}})})),a(4,(function(t){Q(()=>{t.fillStyle="#fff",t.fillRect(0,0,1e3,48),p(t,st.map((t,n)=>`${ot[n]}: ${String(t).padStart(4," ")}`).join("   "),"#000",24,24,0,.5)})})),function(){const t=new Map,n=new Set(w.map(t=>t.toHash()));function e(o,s,[r,a],i=!1,c=r+Math.random()*(a-r)){if((i||!n.has(s.toHash()))&&!(c<=0)){t.set(s.toHash(),o),e(o,s.add(w[Math.floor(Math.random()*w.length)]),[0,0],i,c-1);for(const t of w)n.add(s.add(t).toHash())}}for(let t=-28;t<=28;t+=1)for(let n=-28;n<=28;n+=1){const o=(n**2+t**2)**.5;o<28&&o>26.5&&e(3,new f(n,t),Wt,!0)}for(let n=-28;n<=28;n+=1)for(let o=-28;o<=28;o+=1)if((o**2+n**2)**.5<28){const s=new f(o,n);if(!t.has(s.toHash())){const n=Math.random();n<.4?t.set(s.toHash(),0):n<.85?t.set(s.toHash(),1):n<.95?e(2,s,jt):e(3,s,Wt)}t.has(s.toHash())||t.set(s.toHash(),0)}t.set(new f(0,0).toHash(),0);for(const[n,e]of t.entries()){const t=u(n);a(0,zt(t,e),t)}}(),document.body.append($),$.addEventListener("mousemove",t=>{W=Y(N(t))}),document.addEventListener("mousemove",t=>{j&&(W=Y(N(t)),!J&&j.relative.distance(W.relative)>5&&(J=!0),J&&(I=G(W.relative,j.canvas),W=Y(N(t))))}),$.addEventListener("contextmenu",t=>{t.preventDefault()}),$.addEventListener("wheel",t=>{z&&(q(),z=void 0),W&&(P=Math.max(.5,Math.min(1,P-.0625*Math.sign(t.deltaY))),I=G(W.relative,W.canvas))}),$.addEventListener("mouseout",()=>{J||(W=void 0)}),$.addEventListener("mousedown",t=>{if(t.preventDefault(),W=Y(N(t)),z){if(function(t){for(const[n,[,e]]of C.entries())if(R(t,n))return Array.isArray(e)?D(e):(q(),e()),!0;return q(),!1}(W.relative))return O=!0,void(L()||(z=void 0));z.equal(W.hex)&&(O=!0),z=void 0}j=W}),$.addEventListener("mouseup",t=>{if(W=Y(N(t)),!J&&!O&&j&&j.hex.equal(W.hex)){const t=function(t){const n=t.toHash();if(!vt.has(n))return;const[e,,,o]=vt.get(n);return o?[["cancel",()=>function(t){const[,,,n]=vt.get(t.toHash());n()}(t)]]:0===e?[["build",[[wt[3][0],()=>bt(t,3)],[wt[2][0],()=>bt(t,2)]]]]:wt[e][3]?void 0:[["destroy",()=>function(t){const[n]=vt.get(t.toHash()),[,e]=wt[n];ct(e,.5),function(t){const[n]=vt.get(t.toHash());Ht(t,0,!0),pt(n)&&Mt(t)}(t)}(t)]]}(j.hex);t&&(z=j.hex,D(t,j.relative))}}),document.addEventListener("mouseup",()=>{W&&(W.relative.x<0||W.relative.y<0||W.relative.x>1e3||W.relative.y>1e3)&&(W=void 0),j=void 0,J=!1,O=!1}),document.addEventListener("visibilitychange",()=>{W=void 0,j=void 0,J=!1,O=!1}),nt((function(t){At=.10416666666666666*t%5}),1/0),a(2,(function(t){t.beginPath();for(const n of yt){const e=u(n);if(!e.equal(K())){const n=e.toCanvas();for(let o=0;o<6;o+=1)vt.has(e.add(w[o]).toHash())||(t.moveTo(...n.add(l[o]).toArray()),t.lineTo(...n.add(l[(o+1)%6]).toArray()))}}t.lineJoin="round",t.lineWidth=4.5,t.strokeStyle="#fff",t.lineDashOffset=Ct,t.setLineDash([6,4]),t.stroke(),t.lineDashOffset=0,t.setLineDash([])})),nt((function(t){Ct=.20833333333333331*t%10}),1/0),a(1,(function(t){console.log("drawGosteks");for(const[n,[e,o]]of Dt)console.log(n,e,o),t.beginPath(),t.moveTo(...e.mul(o).add(n.mul(1-o)).toCanvas().toArray()),t.lineTo(...e.toCanvas().toArray()),t.lineWidth=3,t.strokeStyle="black",t.stroke()})),vt.clear(),gt.clear(),yt.clear(),xt(new f(0,0),1),xt(new f(3,-1),2),function(){qt.clear(),Dt.clear();for(let t=0;t<10;t+=1)qt.add(new f(2,0))}(),$t.clear(),$t.add([new f(2,-2),[0,2,1,0,0]]),st.fill(0),rt.clear(),function(t,n){const[e]=at(t);ft(e,n),ft(st,n)}(new f(0,0),[0,8,6,0,0]),function t(n){requestAnimationFrame(t),n>=It+15.666666666666668&&(It=n,U+=1,function(){for(const[t,n]of tt.entries()){const e=U-n.frame;e>n.totalFrames?tt.delete(t):e>=0&&n.run(e,n.totalFrames)}}(),function(){if(Tt())for(const[t,n]of $t)n.some(t=>t>0)&&Tt()&&Lt(t,t=>{const e=it(t,n);return Rt(t,e.length,t=>{const n=[t,0,[0,0,0,0,0]];return console.log("here",e.length),nt((t,e)=>{n[1]=t/e},1e3),n}),!n.some(t=>t>0)})}(),function(){F.resetTransform(),F.clearRect(0,0,1e3,1e3),F.translate(500,500),F.scale(P,P),F.translate(-I.x,-I.y);const t=[[],[],[],[],[],[]],n=I.toHex();for(const[e,o,s]of r.values())s&&!X(s,n)||t[e].push(o);for(const n of t)for(const t of n)t(F)}())}(0);</script>
